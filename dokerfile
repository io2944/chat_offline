# Étape 1 : builder l’app
FROM node:20-bookworm-slim AS build

# Créer dossier app
WORKDIR /app

# Copier dépendances
COPY package*.json ./
RUN npm install

# Copier le code
COPY . .

# Compiler si tu utilises TypeScript
RUN npm install -g typescript && tsc

# Étape 2 : image finale minimale
FROM node:20-bookworm-slim

WORKDIR /app

# Installer SQLite (better-sqlite3 a besoin de build tools)
RUN apt-get update && apt-get install -y python3 make g++ sqlite3 \
  && rm -rf /var/lib/apt/lists/*

# Copier depuis l’étape de build
COPY --from=build /app /app

EXPOSE 8080

# Lancer le serveur (si ton entrypoint compilé est dans dist/)
CMD ["node", "dist/server.js"]
